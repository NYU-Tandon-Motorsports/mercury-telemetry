sudo: true
dist: xenial
os: linux
language: ruby

jobs:
  include:
    - language: python

      python:
        - '3.6'

      addons:
        firefox: latest

      dist: xenial
      services:
        - xvfb

      services:
        - postgresql

      before_install:
        - wget https://github.com/mozilla/geckodriver/releases/download/v0.26.0/geckodriver-v0.26.0-linux64.tar.gz
        - mkdir geckodriver
        - tar -xzf geckodriver-v0.26.0-linux64.tar.gz -C geckodriver
        - export PATH=$PATH:$PWD/geckodriver

      install:
        - pip install --upgrade pip
        - pip install -r requirements.txt
        - pip install -r test-requirements.txt

      before_script:
        - psql -c 'create database mercury;' -U postgres
        - python manage.py migrate
        - python manage.py collectstatic --noinput

      script:
        - black . --check
        - flake8 --exclude tests mysite/ mercury/
        - flake8 --ignore=E501 mercury/tests/
        - coverage run --source=mysite,mercury --omit="mercury/migrations/*" manage.py test

      after_script:
        - coveralls
        - cat geckodriver.log

        # run the hardware tests
    - services:
          - docker
        
      before_script:
        # prepare qemu
        - docker run --rm --privileged multiarch/qemu-user-static:register --reset
        # build image
        - docker build -t gcivil-nyu-org/spring2020-cs-gy-9223-class .
        
      script:
        - docker run -rm gcivil-nyu-org/spring2020-cs-gy-9223-class cat hello.txt
            
